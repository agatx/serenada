services:
  # Go Application Server
  app-server:
    build:
      context: ./server
    container_name: connected-server
    environment:
      - PORT=8080
      - TURN_SECRET=${TURN_SECRET}
      - TURN_HOST=${TURN_HOST}
    restart: unless-stopped
    networks:
      - connected-net

  # Coturn Server
  coturn:
    image: coturn/coturn:latest
    container_name: connected-coturn
    restart: unless-stopped
    volumes:
      - ./coturn/turnserver.conf:/etc/coturn/turnserver.conf
    # network_mode: "host" # Needed for huge UDP port ranges efficiently, or map ports explicitly but that is verbose
    # If host mode is not preferred, we need to map 3478:3478/udp and range
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "49152-49200:49152-49200/udp"

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: connected-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./client/dist:/var/www/connected/dist
      - /etc/letsencrypt:/etc/letsencrypt
    depends_on:
      - app-server
    networks:
      - connected-net

networks:
  connected-net:
